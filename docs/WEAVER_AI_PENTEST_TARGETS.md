# Weaver.AI Penetration Testing Targets

## Overview
Comprehensive list of all testable endpoints, infrastructure, and attack surfaces in the Weaver.AI framework for security assessment and penetration testing.

## 1. HTTP API Endpoints

### Core Gateway Endpoints
```
GET  /health                    - Health check endpoint (no auth)
GET  /whoami                    - User authentication verification
POST /ask                       - Main query processing endpoint
```

### Test Gateway Endpoints
```
GET  /pool-stats                - Connection pool statistics
GET  /cache/stats               - Redis cache statistics
```

## 2. Authentication & Authorization Attack Surfaces

### JWT Authentication
- **Endpoint**: All endpoints except `/health`
- **Headers**: `Authorization: Bearer <token>`
- **Attack Vectors**:
  - JWT algorithm confusion (alg: none, HS256/RS256 confusion)
  - Weak secret key brute force
  - Token expiration bypass
  - Token signature validation bypass
  - Privilege escalation via token manipulation

### Rate Limiting
- **Configuration**: `RATE_LIMIT_RPM` environment variable
- **Attack Vectors**:
  - Rate limit bypass via header manipulation
  - Distributed rate limit evasion
  - Race condition exploitation

## 3. Redis Infrastructure

### ResultPublisher Operations
```
Redis Keys:
- results:{result_id}:data       - Result data storage
- results:{result_id}:metadata   - Result metadata
- results:workflows:{workflow_id} - Workflow indexing
- results:agents:{agent_id}      - Agent result tracking
- results:capabilities:{cap}     - Capability-based access
- results:lineage:{parent_id}    - Result lineage tracking
```

**Attack Vectors**:
- Redis command injection
- Key enumeration and data leak
- TTL manipulation
- Unauthorized result access
- Capability bypass

### Memory Persistence
```
Redis Keys:
- memory:{agent_id}:short_term   - Short-term memory storage
- memory:{agent_id}:long_term    - Long-term memory storage
```

**Attack Vectors**:
- Memory poisoning
- Cross-agent memory access
- Memory overflow attacks
- TTL exploitation

### Event Mesh Communication
```
Redis Channels:
- events:{capability}            - Capability-based event channels
- broadcast                      - Global broadcast channel
```

**Attack Vectors**:
- Channel hijacking
- Event injection
- Message replay attacks
- Unauthorized subscription

### Work Queue
```
Redis Keys:
- queue:{queue_name}             - Task queue
- queue:{queue_name}:processing  - Tasks being processed
```

**Attack Vectors**:
- Queue poisoning
- Task injection
- Priority manipulation
- DoS via queue flooding

### Agent Registry
```
Redis Keys:
- agents:{agent_id}              - Agent registration data
- agents:capabilities:{cap}      - Capability registry
```

**Attack Vectors**:
- Agent impersonation
- Capability escalation
- Registry manipulation

## 4. Model Integration Points

### Model Router
- **Endpoints**: Internal via `/ask`
- **Attack Vectors**:
  - Model confusion (forcing wrong model)
  - Prompt injection
  - Token exhaustion
  - Response manipulation

### Supported Models
- OpenAI GPT models
- Anthropic Claude models
- Local/custom models

## 5. MCP (Model Context Protocol) Tool System

### Tool Execution
- **Python eval server** (high risk)
- **Attack Vectors**:
  - Code injection via eval
  - Sandbox escape
  - Resource exhaustion
  - File system access

### Tool Registration
- **Attack Vectors**:
  - Malicious tool registration
  - Tool impersonation
  - Capability bypass

## 6. Security Policy Enforcement

### Input Guards
- **Location**: `/ask` endpoint
- **Config**: `policies/guardrails.yaml`
- **Attack Vectors**:
  - Policy bypass via encoding
  - Input validation bypass
  - Injection via policy gaps

### Output Guards
- **PII Redaction**: `PII_REDACT` flag
- **Attack Vectors**:
  - PII leak via bypass
  - Output manipulation
  - Redaction evasion

## 7. Agent Communication Channels

### A2A Protocol
```
Message Flow:
Agent A -> A2AEnvelope -> Agent B
```

**Attack Vectors**:
- Message interception
- Envelope manipulation
- Replay attacks
- Agent spoofing

### Capability-Based Access
- **Attack Vectors**:
  - Capability escalation
  - Token forgery
  - Access control bypass

## 8. Workflow Orchestration

### AgentOrchestrator
- **Attack Vectors**:
  - Workflow manipulation
  - Task injection
  - Result tampering
  - Orchestration hijacking

### Multi-Agent Coordination
- **Attack Vectors**:
  - Agent isolation breach
  - Cross-agent data leak
  - Coordination manipulation

## 9. Data Storage & Persistence

### S3 Backup (if enabled)
- **Attack Vectors**:
  - S3 bucket misconfiguration
  - Data exfiltration
  - Backup manipulation

### Local File System
- **Attack Vectors**:
  - Path traversal
  - File injection
  - Permission escalation

## 10. Telemetry & Monitoring

### OpenTelemetry Integration
- **Attack Vectors**:
  - Telemetry data leak
  - Metric manipulation
  - Log injection

### Audit Logging
- **Attack Vectors**:
  - Log tampering
  - Audit trail deletion
  - Log injection attacks

## 11. Environment Variables & Configuration

### Critical Environment Variables
```
JWT_SECRET                - Authentication key
OPENAI_API_KEY           - Model API access
RATE_LIMIT_RPM           - Rate limiting config
PII_REDACT               - PII redaction flag
LOG_LEVEL                - Logging verbosity
```

**Attack Vectors**:
- Environment variable injection
- Configuration manipulation
- Secret extraction

## 12. Docker & Deployment

### Container Security
- **Attack Vectors**:
  - Container escape
  - Image vulnerabilities
  - Network exposure
  - Volume mount exploitation

### Docker Compose Services
```
Services:
- weaver-ai              - Main application
- redis                  - Redis database
- test runners           - Test containers
```

## 13. Specific Vulnerability Categories to Test

### Injection Attacks
- SQL Injection (if DB used)
- NoSQL Injection (Redis)
- Command Injection
- Code Injection (eval)
- Prompt Injection
- Log Injection
- Header Injection

### Authentication & Session
- JWT vulnerabilities
- Session fixation
- Credential stuffing
- Brute force attacks
- Token replay

### Access Control
- IDOR vulnerabilities
- Privilege escalation
- Capability bypass
- Path traversal
- Directory traversal

### Data Exposure
- Information disclosure
- Error message leaks
- Stack trace exposure
- Configuration exposure
- Memory dumps

### Denial of Service
- Rate limit bypass
- Resource exhaustion
- Queue flooding
- Memory exhaustion
- CPU exhaustion

### Business Logic
- Workflow manipulation
- State confusion
- Race conditions
- Time-of-check/Time-of-use

## 14. Testing Commands

### Local Testing
```bash
# Run with real API
export OPENAI_API_KEY='your-key'
export JWT_SECRET='your-secret'
python3 run_weaver_ai_pentest.py

# Run in simulation mode
python3 run_weaver_ai_pentest.py --simulate
```

### Docker Testing
```bash
# Full stack test
docker-compose up -d
python3 run_weaver_ai_pentest.py --target http://localhost:8000

# Isolated test
docker run --rm weaver-ai-pentest
```

## 15. Pentest Agent Specializations Needed

### WeaveAIReconAgent
- Endpoint discovery
- Service enumeration
- Configuration detection
- Technology fingerprinting

### WeaveAIAuthAgent
- JWT testing
- Authentication bypass
- Session management
- Rate limit testing

### WeaveAIRedisAgent
- Redis command injection
- Key enumeration
- Data extraction
- Pub/sub manipulation

### WeaveAIModelAgent
- Prompt injection
- Model confusion
- Token exhaustion
- Response manipulation

### WeaveAIWorkflowAgent
- Workflow manipulation
- Agent coordination testing
- Result tampering
- Orchestration attacks

### WeaveAIExploitAgent
- Exploit development
- Payload generation
- Sandbox escape
- Privilege escalation

### WeaveAIReportAgent
- Vulnerability aggregation
- Risk assessment
- Remediation planning
- Compliance mapping

## Next Steps

1. **Create `run_weaver_ai_pentest.py`** with all specialized agents
2. **Implement comprehensive test scenarios** for each attack surface
3. **Add CI/CD integration** for automated security testing
4. **Create remediation playbooks** for discovered vulnerabilities
5. **Establish security baseline** and monitoring

## Priority Targets

### Critical (Test First)
1. JWT authentication bypass
2. Python eval code injection
3. Redis command injection
4. Rate limit bypass
5. Capability escalation

### High Priority
1. Result publisher access control
2. Agent impersonation
3. Workflow manipulation
4. Memory poisoning
5. Prompt injection

### Medium Priority
1. Information disclosure
2. Log injection
3. Telemetry manipulation
4. Configuration exposure
5. Error handling

### Low Priority
1. Performance issues
2. Minor information leaks
3. Best practice violations
4. Documentation issues
