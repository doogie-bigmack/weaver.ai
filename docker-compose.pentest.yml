version: '3.8'

services:
  # Redis backend for ResultPublisher
  redis-pentest:
    image: redis:7-alpine
    container_name: weaver-redis-pentest
    ports:
      - "6381:6379"  # Different port to avoid conflicts
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-pentest-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - pentest-network

  # Penetration test runner with GPT
  pentest-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: weaver-pentest-runner
    environment:
      - PYTHONUNBUFFERED=1
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=redis://redis-pentest:6379
      - LOG_LEVEL=INFO
    depends_on:
      redis-pentest:
        condition: service_healthy
    volumes:
      - ./weaver_ai:/app/weaver_ai
      - ./tests:/app/tests
      - ./run_pentest_with_gpt.py:/app/run_pentest_with_gpt.py
      - ./pentest-results:/app/results
    command: python run_pentest_with_gpt.py
    networks:
      - pentest-network

volumes:
  redis-pentest-data:

networks:
  pentest-network:
    driver: bridge
