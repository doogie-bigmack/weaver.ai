"""Simplified multi-agent security penetration testing workflow.

Demonstrates agent coordination through ResultPublisher without unnecessary boilerplate.
"""

import asyncio
from typing import Any

import pytest
import pytest_asyncio
import redis.asyncio as redis

from weaver_ai.agents.publisher import ResultPublisher


class SimpleReconAgent:
    """Lightweight recon agent for testing."""

    def __init__(self, agent_id: str = "recon_agent"):
        self.agent_id = agent_id

    async def scan(self, target: str, publisher: ResultPublisher) -> dict[str, Any]:
        """Perform reconnaissance."""
        data = {
            "target": target,
            "open_ports": [22, 80, 443, 3306],
            "services": {"22": "SSH", "80": "HTTP", "443": "HTTPS", "3306": "MySQL"},
            "technologies": ["nginx", "PHP", "MySQL", "WordPress"],
        }

        result = await publisher.publish(
            agent_id=self.agent_id,
            data=data,
            capabilities_required=["security.read"],
            workflow_id="pentest",
        )
        return {"result_id": result.metadata.result_id, "data": data}


class SimpleVulnScanner:
    """Lightweight vulnerability scanner for testing."""

    def __init__(self, agent_id: str = "vuln_scanner"):
        self.agent_id = agent_id

    async def scan(
        self, recon_result_id: str, publisher: ResultPublisher
    ) -> dict[str, Any]:
        """Scan for vulnerabilities."""
        # Retrieve recon results
        recon = await publisher.retrieve(
            recon_result_id, agent_capabilities=["security.read"]
        )

        if not recon:
            return {"error": "Cannot access recon results"}

        # Generate mock vulnerabilities based on recon
        vulnerabilities = []
        if 3306 in recon.data.get("open_ports", []):
            vulnerabilities.append(
                {
                    "service": "MySQL",
                    "severity": "critical",
                    "description": "Database exposed to internet",
                }
            )

        if "WordPress" in recon.data.get("technologies", []):
            vulnerabilities.append(
                {
                    "service": "WordPress",
                    "severity": "high",
                    "description": "Outdated version vulnerable",
                }
            )

        data = {
            "target": recon.data.get("target"),
            "vulnerabilities": vulnerabilities,
            "total": len(vulnerabilities),
            "critical": sum(1 for v in vulnerabilities if v["severity"] == "critical"),
        }

        result = await publisher.publish(
            agent_id=self.agent_id,
            data=data,
            capabilities_required=["security.read"],
            workflow_id="pentest",
            parent_result_id=recon_result_id,
        )
        return {"result_id": result.metadata.result_id, "data": data}


class SimpleReporter:
    """Lightweight report generator for testing."""

    def __init__(self, agent_id: str = "reporter"):
        self.agent_id = agent_id

    async def generate_report(
        self, workflow_id: str, publisher: ResultPublisher
    ) -> dict[str, Any]:
        """Generate security report."""
        # Get all workflow results
        results = await publisher.list_by_workflow(
            workflow_id, agent_capabilities=["security.read"]
        )

        # Count vulnerabilities from results
        total_vulns = 0
        critical_issues = 0

        for metadata in results:
            result = await publisher.retrieve(
                metadata.result_id, agent_capabilities=["security.read"]
            )
            if result and "vulnerabilities" in result.data:
                total_vulns = result.data.get("total", 0)
                critical_issues = result.data.get("critical", 0)

        report = {
            "summary": {
                "workflow": workflow_id,
                "vulnerabilities_found": total_vulns,
                "critical_issues": critical_issues,
                "risk_level": "HIGH" if critical_issues > 0 else "MEDIUM",
            },
            "recommendations": [
                "Patch critical vulnerabilities immediately",
                "Restrict database access",
                "Update WordPress to latest version",
            ],
        }

        result = await publisher.publish(
            agent_id=self.agent_id,
            data=report,
            workflow_id=workflow_id,
            tags={"type": "final_report"},
        )
        return {"result_id": result.metadata.result_id, "report": report}


async def run_simple_pentest(target: str, publisher: ResultPublisher) -> dict[str, Any]:
    """Run a simplified penetration test workflow."""
    results = {}

    # Phase 1: Recon
    recon = SimpleReconAgent()
    recon_result = await recon.scan(target, publisher)
    results["recon"] = recon_result
    print(f"✓ Recon complete: {len(recon_result['data']['open_ports'])} ports found")

    # Phase 2: Vulnerability Scan
    vuln_scanner = SimpleVulnScanner()
    vuln_result = await vuln_scanner.scan(recon_result["result_id"], publisher)
    results["vulnerabilities"] = vuln_result
    print(f"✓ Vuln scan complete: {vuln_result['data']['total']} issues found")

    # Phase 3: Report
    reporter = SimpleReporter()
    report_result = await reporter.generate_report("pentest", publisher)
    results["report"] = report_result
    print(
        f"✓ Report generated: Risk level {report_result['report']['summary']['risk_level']}"
    )

    return results


@pytest_asyncio.fixture
async def redis_client():
    """Create a Redis client for testing."""
    client = await redis.from_url("redis://localhost:6379", db=15)
    yield client
    await client.flushdb()
    await client.close()


@pytest_asyncio.fixture
async def publisher(redis_client):
    """Create a ResultPublisher for testing."""
    pub = ResultPublisher(redis_client=redis_client, namespace="simple_pentest")
    yield pub
    await pub.disconnect()


@pytest.mark.asyncio
async def test_simple_pentest_workflow(publisher):
    """Test simplified security workflow."""
    results = await run_simple_pentest("example.com", publisher)

    # Verify all phases completed
    assert "recon" in results
    assert "vulnerabilities" in results
    assert "report" in results

    # Verify data flow
    assert results["vulnerabilities"]["data"]["total"] > 0
    assert results["report"]["report"]["summary"]["vulnerabilities_found"] > 0

    # Verify lineage tracking
    lineage = await publisher.get_lineage(results["recon"]["result_id"])
    assert len(lineage) >= 1


@pytest.mark.asyncio
async def test_access_control_simple(publisher):
    """Test that access control works."""
    # Agent publishes restricted result
    result = await publisher.publish(
        agent_id="secure_agent",
        data={"secret": "classified"},
        capabilities_required=["admin"],
    )

    # Cannot access without capability
    retrieved = await publisher.retrieve(
        result.metadata.result_id, agent_capabilities=["user"]
    )
    assert retrieved is None

    # Can access with capability
    retrieved = await publisher.retrieve(
        result.metadata.result_id, agent_capabilities=["admin"]
    )
    assert retrieved is not None
    assert retrieved.data["secret"] == "classified"


if __name__ == "__main__":
    # Demo without pytest

    async def demo():
        # Mock publisher for demo
        from unittest.mock import AsyncMock

        publisher = ResultPublisher()
        publisher.redis = AsyncMock()
        publisher._connected = True
        publisher.redis.setex = AsyncMock(return_value=True)
        publisher.redis.sadd = AsyncMock(return_value=1)
        publisher.redis.zadd = AsyncMock(return_value=1)
        publisher.redis.expire = AsyncMock(return_value=True)
        publisher.redis.smembers = AsyncMock(return_value=[b"result1", b"result2"])
        publisher.redis.get = AsyncMock(return_value=None)

        print("\n=== SIMPLIFIED PENTEST WORKFLOW DEMO ===\n")
        results = await run_simple_pentest("demo.example.com", publisher)

        print("\n=== RESULTS ===")
        print(f"Workflow completed with {len(results)} phases")
        print(
            f"Final risk level: {results['report']['report']['summary']['risk_level']}"
        )

    asyncio.run(demo())
