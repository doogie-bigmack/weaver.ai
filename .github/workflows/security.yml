name: Security Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'pyproject.toml'
      - 'requirements*.txt'

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  vulnerability-scan:
    name: Vulnerability Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
          pip install pip-audit safety bandit cyclonedx-bom

      - name: Run pip-audit
        id: pip-audit
        run: |
          echo "## Pip Audit Results" >> $GITHUB_STEP_SUMMARY
          pip-audit --desc --format json > pip-audit.json || true
          pip-audit --desc >> $GITHUB_STEP_SUMMARY || true

      - name: Run safety check
        id: safety
        run: |
          echo "## Safety Check Results" >> $GITHUB_STEP_SUMMARY
          safety check --json > safety-report.json || true
          safety check >> $GITHUB_STEP_SUMMARY || true

      - name: Run bandit security linter
        run: |
          echo "## Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          bandit -r weaver_ai -f json -o bandit-report.json || true
          bandit -r weaver_ai >> $GITHUB_STEP_SUMMARY || true

      - name: Generate SBOM
        run: |
          echo "## Software Bill of Materials" >> $GITHUB_STEP_SUMMARY
          python -m cyclonedx_bom.cli.pip -o sbom.json --format json
          echo "SBOM generated: sbom.json" >> $GITHUB_STEP_SUMMARY

      - name: Check for critical vulnerabilities
        id: check-critical
        run: |
          python -c "
          import json
          import sys

          critical_found = False

          # Check pip-audit results
          try:
              with open('pip-audit.json', 'r') as f:
                  audit_data = json.load(f)
                  if audit_data.get('dependencies', []):
                      for dep in audit_data['dependencies']:
                          if dep.get('vulns', []):
                              for vuln in dep['vulns']:
                                  if 'CRITICAL' in vuln.get('fix_versions', []):
                                      critical_found = True
                                      print(f'CRITICAL: {dep[\"name\"]} - {vuln.get(\"id\", \"Unknown\")}')
          except:
              pass

          if critical_found:
              print('::error::Critical vulnerabilities found!')
              sys.exit(1)
          else:
              print('No critical vulnerabilities found.')
          "

      - name: Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            pip-audit.json
            safety-report.json
            bandit-report.json
            sbom.json

      - name: Create issue for vulnerabilities
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸš¨ Security Vulnerabilities Detected';
            const body = `Critical security vulnerabilities were detected in the scheduled security scan.

            **Scan Date**: ${new Date().toISOString()}
            **Workflow Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            Please review the security scan artifacts and address the vulnerabilities.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'critical']
            });

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-licenses

      - name: Check licenses
        run: |
          echo "## License Report" >> $GITHUB_STEP_SUMMARY
          pip-licenses --format=markdown >> $GITHUB_STEP_SUMMARY

          # Check for problematic licenses
          pip-licenses --fail-on="GPL;LGPL;AGPL;SSPL" || true
